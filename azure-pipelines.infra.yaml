trigger:
  batch: true
  branches:
    include:
    - '*'
  paths:
    include:
    - example/deployment/azure-infra/terraform/*
    - azure-pipelines.infra.yaml

stages:
- stage: Deploy_Infra
  jobs:
    - job:
      variables: 
      - group: project-variables
      steps:
      - task: charleszipp.azure-pipelines-tasks-terraform.azure-pipelines-tasks-terraform-cli.TerraformCLI@0
        displayName: 'terraform init'
        inputs:
          command: init
          workingDirectory: '$(System.DefaultWorkingDirectory)/example/deployment/azure-infra/terraform'
          backendType: azurerm
          backendServiceArm: 'Demos (802df257-6032-4b50-884c-55cb9f074928)'
          ensureBackend: true
          backendAzureRmResourceGroupName: 'tmp-tfstate'
          backendAzureRmResourceGroupLocation: uksouth
          backendAzureRmStorageAccountName: 'tfstatepalisade'
          backendAzureRmContainerName: tfstate
          backendAzureRmKey: palisade

      - task: charleszipp.azure-pipelines-tasks-terraform.azure-pipelines-tasks-terraform-cli.TerraformCLI@0
        displayName: 'terraform plan'
        inputs:
          command: plan
          workingDirectory: '$(System.DefaultWorkingDirectory)/example/deployment/azure-infra/terraform'
          environmentServiceName: 'Demos (802df257-6032-4b50-884c-55cb9f074928)'
          commandOptions: '-var-file default.tfvars -var client_id=$(sp_id) -var client_secret=$(sp_pass) -var subscription_id=$(subscription_id)  -out plan'

      - task: charleszipp.azure-pipelines-tasks-terraform.azure-pipelines-tasks-terraform-cli.TerraformCLI@0
        displayName: 'terraform apply'
        inputs:
          command: apply
          workingDirectory: '$(System.DefaultWorkingDirectory)/example/deployment/azure-infra/terraform'
          environmentServiceName: 'Demos (802df257-6032-4b50-884c-55cb9f074928)'
          commandOptions: plan

      
      - task: HelmDeploy@0
        displayName: 'helm init'
        inputs:
          azureSubscription: 'Demos (802df257-6032-4b50-884c-55cb9f074928)'
          azureResourceGroup: 'tmp-palisade-aks'
          kubernetesCluster: 'palisade-aks'
          command: init
          arguments: ' --upgrade'

